<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Carbon Credit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: contain;
        font-family: "Prompt", sans-serif;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="flex flex-col items-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-green-600 border-t-transparent"
        ></div>
        <p class="mt-4 text-gray-600 font-prompt">กำลังโหลด...</p>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-4 pb-24 sm:py-8 max-w-3xl">
      <div id="profileComponent" class="mb-6"></div>

      <!-- Carbon Credit Form -->
      <div id="carbonCreditForm" class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">ลงทะเบียน Carbon Credit</h2>

        </div>
        <form id="farmDataForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >พื้นที่เพาะปลูก (ไร่)</label
              >
              <input
                type="number"
                id="farmArea"
                min="0.1"
                step="0.1"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                required
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >วันที่เริ่มรอบ</label
              >
              <input
                type="date"
                id="cycleStart"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >วันที่สิ้นสุดรอบ</label
              >
              <input
                type="date"
                id="cycleEnd"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                required
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700"
              >ระยะเวลาช่วงแห้ง (วัน)</label
            >
            <input
              type="number"
              id="dryPeriod"
              min="1"
              max="120"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
          >
            บันทึกข้อมูล
          </button>
        </form>
      </div>

      <!-- Records Table -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6 mx-auto max-w-full">
        <h2 class="text-lg md:text-xl font-semibold mb-4 text-center">ประวัติการลงทะเบียน</h2>
        
        <div class="overflow-x-auto -mx-4 md:mx-0">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  พื้นที่ (ไร่)
                </th>
                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  วันที่เริ่ม
                </th>
                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  วันที่สิ้นสุด
                </th>
                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  ช่วงแห้ง (วัน)
                </th>
                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  เครดิต
                </th>
              </tr>
            </thead>
            <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      

      <!-- Carbon Credit Summary -->
      <div id="creditSummary" class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4 text-center">สรุป Carbon Credit</h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <p class="text-xs md:text-sm text-gray-600 mb-1">เครดิตสะสม</p>
            <p id="totalCredits" class="text-xl md:text-2xl font-semibold text-green-600">
              0
            </p>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <p class="text-xs md:text-sm text-gray-600 mb-1">การลดก๊าซเรือนกระจก<br class="sm:hidden"> (kg CO2)</p>
            <p id="totalReduction" class="text-xl md:text-2xl font-semibold text-green-600">
              0
            </p>
          </div>
        </div>
      </div>
      <!-- ปุ่มแถบด้านล่าง Fixed -->
<div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
  <div class="max-w-screen-xl mx-auto">
    <button
      id="exportBtn"
      class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-base font-medium hover:bg-green-700 active:bg-green-800 transition-colors duration-200 flex items-center justify-center gap-2 shadow-md"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
      Export ข้อมูล
    </button>
  </div>
</div>

<!-- เพิ่ม padding ด้านล่างให้กับ content เพื่อไม่ให้ถูกปุ่มบัง -->
<div class="pb-24"></div>

      

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-24 left-4 right-4 z-50 pointer-events-none"
    ></div>

    <!-- Scripts -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="./utils/constants.js"></script>
    <script src="./components/Profile.js"></script>
    <script>
      // Global state
      const state = {
        userId: null,
        profile: null,
        records: [],
        farmData: {
          credits: 0,
          reduction: 0,
        },
      };

      // Carbon Credit Calculations
      function calculateCarbonCredit(farmArea, dryPeriod) {
        const reductionPerRai = 500; // 0.5 ตัน = 500 kg
        const reduction = farmArea * reductionPerRai * (dryPeriod / 30);
        const credits = reduction / 1000;
        return { reduction, credits };
      }

      // UI Helper Functions
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `mb-2 p-4 rounded-lg text-center pointer-events-auto ${
          type === "success"
            ? "bg-green-100 text-green-700 border border-green-400"
            : "bg-red-100 text-red-700 border border-red-400"
        }`;
        toast.textContent = message;

        const container = document.getElementById("toastContainer");
        container.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transition = "opacity 0.3s ease-out";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("th-TH", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function updateTable() {
        const tbody = document.getElementById("recordsTableBody");
        tbody.innerHTML = "";

        state.records.forEach((record) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                      record.farmArea
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(
                      record.cycleStart
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(
                      record.cycleEnd
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                      record.dryPeriod
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.credits.toFixed(
                      2
                    )}</td>
                `;
          tbody.appendChild(row);
        });
      }

      function updateSummary() {
        const totalCredits = state.records.reduce(
          (sum, record) => sum + record.credits,
          0
        );
        const totalReduction = state.records.reduce(
          (sum, record) => sum + record.reduction,
          0
        );

        document.getElementById("totalCredits").textContent =
          totalCredits.toFixed(2);
        document.getElementById("totalReduction").textContent =
          totalReduction.toFixed(0);
      }

      // Export Function
      function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(
          state.records.map((record) => ({
            "พื้นที่ (ไร่)": record.farmArea,
            วันที่เริ่ม: formatDate(record.cycleStart),
            วันที่สิ้นสุด: formatDate(record.cycleEnd),
            "ช่วงแห้ง (วัน)": record.dryPeriod,
            เครดิต: record.credits.toFixed(2),
            "การลดก๊าซเรือนกระจก (kg CO2)": record.reduction.toFixed(2),
          }))
        );

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Carbon Credits");

        const fileName = `carbon_credits_${
          new Date().toISOString().split("T")[0]
        }.xlsx`;
        XLSX.writeFile(wb, fileName);
      }

      // Form Handling
      document
        .getElementById("farmDataForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            farmArea: parseFloat(document.getElementById("farmArea").value),
            cycleStart: document.getElementById("cycleStart").value,
            cycleEnd: document.getElementById("cycleEnd").value,
            dryPeriod: parseInt(document.getElementById("dryPeriod").value),
          };

          const { reduction, credits } = calculateCarbonCredit(
            formData.farmArea,
            formData.dryPeriod
          );

          const record = {
            ...formData,
            reduction,
            credits,
            timestamp: new Date().toISOString(),
          };

          state.records.push(record);
          updateTable();
          updateSummary();

          e.target.reset();
          showToast("บันทึกข้อมูลสำเร็จ");
        });

      // Export Button Handler
      document
        .getElementById("exportBtn")
        .addEventListener("click", exportToExcel);

      // Initialize Application
      async function main() {
        try {
          // Initialize LIFF
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          state.userId = profile.userId;
          state.profile = profile;
          initializeProfile(profile);

          // Here you would typically load saved records from backend
          // For now we'll use sample data
          updateTable();
          updateSummary();

          document.getElementById("loadingOverlay").style.display = "none";

        

    
        } catch (error) {
          console.error("Error initializing app:", error);
          showToast("เกิดข้อผิดพลาดในการโหลดแอป", "error");
        }
      }

      // Form Validation
      function setupFormValidation() {
        const cycleStartInput = document.getElementById("cycleStart");
        const cycleEndInput = document.getElementById("cycleEnd");
        const dryPeriodInput = document.getElementById("dryPeriod");

        cycleStartInput.addEventListener("change", () => {
          const startDate = new Date(cycleStartInput.value);
          const endDate = new Date(cycleEndInput.value);

          if (endDate && startDate > endDate) {
            cycleEndInput.value = "";
            showToast("วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด", "error");
          }
        });

        cycleEndInput.addEventListener("change", () => {
          const startDate = new Date(cycleStartInput.value);
          const endDate = new Date(cycleEndInput.value);

          if (startDate && endDate < startDate) {
            cycleEndInput.value = "";
            showToast("วันที่สิ้นสุดต้องมาหลังวันที่เริ่มต้น", "error");
          }
        });

        dryPeriodInput.addEventListener("input", () => {
          const value = parseInt(dryPeriodInput.value);
          if (value < 1) {
            dryPeriodInput.value = 1;
          } else if (value > 120) {
            dryPeriodInput.value = 120;
          }
        });
      }

      // Initialize form validation
      setupFormValidation();

      // Start the application
      main();
    </script>
  </body>
</html>
